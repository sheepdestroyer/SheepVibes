# Podman Quadlet for the SheepVibes Pod

################################################################################
# [Unit] Section
# ------------------------------------------------------------------------------
# This section provides metadata about the systemd unit.
################################################################################

[Unit]
Description=SheepVibes Application Pod
Requires=network-online.target
After=network-online.target


################################################################################
# [Pod] Section
# ------------------------------------------------------------------------------
# This section defines the pod, which is a group of containers that share
# resources, such as the network namespace.
################################################################################

[Pod]
# Publishes a port from the pod to the host.
# Format: IP:HOST_PORT:CONTAINER_PORT
PublishPort=127.0.0.1:5000:5000


################################################################################
# [Volume] Sections
# ------------------------------------------------------------------------------
# These sections define the persistent storage volumes used by the containers.
################################################################################

[Volume/sheepvibes-db]
# Defines a volume for the application's database.
# systemd will create a volume named 'sheepvibespod-sheepvibes-db'.

[Volume/sheepvibes-redis]
# Defines a volume for the Redis cache data.
# systemd will create a volume named 'sheepvibespod-sheepvibes-redis'.


################################################################################
# [Container] Sections
# ------------------------------------------------------------------------------
# These sections define the individual containers that will run within the pod.
################################################################################

# --- Application Container ---
[Container/app]
# Specifies that this container belongs to the defined pod.
Pod=sheepvibespod.pod

# Sets a custom name for the container.
ContainerName=sheepvibes-app

# The container image to use.
Image=ghcr.io/sheepdestroyer/sheepvibes:latest

# Mounts the 'sheepvibes-db' volume into the container at '/app/data'.
Volume=sheepvibes-db.volume:/app/data

# --- Environment Variables for the Application ---
Environment=DATABASE_PATH=/app/data/sheepvibes.db
Environment=CACHE_REDIS_URL=redis://localhost:6379/0
Environment=FLASK_APP=backend.app
Environment=PYTHONPATH=/app
Environment=UPDATE_INTERVAL_MINUTES=15
Environment=FLASK_RUN_HOST=0.0.0.0

# --- Service Options for the Application Container ---
# Automatically restart the container if it fails.
Restart=on-failure

# Increases the startup timeout to allow for image pulls or slow initialization.
TimeoutStartSec=180


# --- Redis Container ---
[Container/redis]
# Specifies that this container belongs to the defined pod.
Pod=sheepvibespod.pod

# Sets a custom name for the container.
ContainerName=sheepvibes-redis

# The container image to use.
Image=docker.io/redis:alpine

# Mounts the 'sheepvibes-redis' volume into the container at '/data'.
Volume=sheepvibes-redis.volume:/data

# --- Service Options for the Redis Container ---
# Automatically restart the container if it fails.
Restart=on-failure

# Sets the startup timeout.
TimeoutStartSec=90


################################################################################
# [Install] Section
# ------------------------------------------------------------------------------
# This section defines the target to which this unit should be linked when
# it is enabled with 'systemctl enable'.
################################################################################

[Install]
# Ensures this pod is started at boot when the default target is reached.
WantedBy=default.target
